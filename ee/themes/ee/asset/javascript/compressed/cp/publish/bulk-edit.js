/*!
 * This source file is part of the open source project
 * ExpressionEngine (https://expressionengine.com)
 *
 * @link      https://expressionengine.com/
 * @copyright Copyright (c) 2003-2018, EllisLab, Inc. (https://ellislab.com)
 * @license   https://expressionengine.com/license Licensed under Apache License, Version 2.0
 */
!function(t){EE.cp.BulkEdit={modal:t('div[rel="modal-bulk-edit"]'),formContainer:t(".app-modal__content .col.w-12.remove-pad--right",this.modal),ajaxRequest:null,intent:null,intentFormUrls:{"bulk-edit":EE.publishEdit.bulkEditFormUrl,"add-categories":EE.publishEdit.addCategoriesFormUrl,"remove-categories":EE.publishEdit.removeCategoriesFormUrl},openForm:function(t,i){this.intent=t;var e=this._formatItems(i);this._renderEntryList(e),this.formContainer.html('<span class="btn work">Loading</span>'),this._loadForm(e),this.modal.trigger({type:"modal:open",linkIs:"js-modal--destruct"})},_renderEntryList:function(t){var i=this;BulkEditEntries.render(this.modal,{items:t,lang:EE.bulkEdit.lang,entriesChanged:function(t){i._loadForm(t)}})},_formatItems:function(i){return t.map(i,function(i){return{label:t(i).data("title"),value:t(i).val()}})},_getEntryIdsFromItems:function(i){return t.map(i,function(t){return t.value})},_loadForm:function(i){if(this.ajaxRequest&&this.ajaxRequest.abort(),0==i.length)return this.modal.trigger("modal:close");var e=t("form",this.modal),n=this._getEntryIdsFromItems(i),a=e.serialize()+"&"+t.param({entry_ids:n}),r=this;this.ajaxRequest=t.ajax({url:this.intentFormUrls[this.intent],data:a,dataType:"html",success:function(t){r._bindForm(t,n)},error:console.error})},_bindForm:function(i,e){this.formContainer.html(i),this._bindAddField(),this._bindRemoveField(),this._enableOrDisableButtons(),SelectField.renderFields(this.formContainer),EE.cp.datePicker.bind(t('input[rel="date-picker"]')),this.formContainer.find(".fluid-field-templates :input").attr("disabled","disabled"),t.fuzzyFilter();var n=this;this.formContainer.find(".fluid-wrap").find(".js-sorting-container .fluid-item").each(function(i,e){n._toggleMenuItem(t(e).data("fieldName"))}),t("form",this.modal).on("submit",function(){var i=n.formContainer.find("input.btn");i.attr({value:i.data("work-text"),disabled:"disabled"}).addClass("work");var a=t(this).serialize()+"&"+t.param({entry_ids:e});return t.post(this.action,a,function(i){return"string"===t.type(i)?void n._bindForm(i,e):void location.reload()}),!1})},_bindAddField:function(){var i=this;this.modal.off("click",".fluid-actions a[data-field-name]"),this.modal.on("click",".fluid-actions a[data-field-name]",function(e){e.preventDefault();var n=t(this).closest(".fluid-wrap"),a=t(this).data("fieldName"),r=n.find('.fluid-field-templates [data-field-name="'+a+'"]'),d=n.find(".js-sorting-container");r.appendTo(d),d.find(":input").removeAttr("disabled"),i._toggleMenuItem(a,!0),i._enableOrDisableButtons(),t(this).closest(".filters").find(".open").removeClass("open").siblings(".sub-menu").hide(),SelectField.renderFields(d),EE.cp.datePicker.bind(t('input[rel="date-picker"]'))})},_bindRemoveField:function(){var i=this;this.modal.on("click",".fluid-ctrls a.fluid-remove",function(e){e.preventDefault();var n=t(this).closest(".fluid-item");i._toggleMenuItem(n.data("fieldName"),!1),n.appendTo(i.formContainer.find(".fluid-field-templates")),i.formContainer.find(".fluid-field-templates :input").attr("disabled","disabled"),i._enableOrDisableButtons()})},_toggleMenuItem:function(t,i){this.formContainer.find('.fluid-actions a[data-field-name="'+t+'"]').closest("li").toggleClass("hidden",i)},_enableOrDisableButtons:function(){if(0!=this.modal.find(".fluid-wrap").size()){var t=this.formContainer.find(".js-sorting-container .fluid-item").size(),i=this.formContainer.find("input.btn");0==t?i.attr("disabled","disabled"):i.removeAttr("disabled")}}}}(jQuery);