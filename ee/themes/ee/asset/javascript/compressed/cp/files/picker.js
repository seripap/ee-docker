/*!
 * This source file is part of the open source project
 * ExpressionEngine (https://expressionengine.com)
 *
 * @link      https://expressionengine.com/
 * @copyright Copyright (c) 2003-2018, EllisLab, Inc. (https://ellislab.com)
 * @license   https://expressionengine.com/license Licensed under Apache License, Version 2.0
 */
"use strict";function loadSettingsModal(t,e){$("div.box",t).html(e),EE.cp.formValidation.init(t),$("form",t).on("submit",function(){return $.ajax({type:"POST",url:this.action,data:$(this).serialize()+"&save_modal=yes",dataType:"json",success:function(e){"success"==e.messageType?t.trigger("modal:close"):loadSettingsModal(t,e.body)}}),!1})}!function(t){var e=function(e,i){var a=t("."+i.rel),n=function(t){var e={modal:a,input_value:i.input_value,input_name:i.input_name,input_img:i.input_img,source:i.source};i.callback(t,e)};t.get(e,function(t){if(a.find("div.box").html(t),"undefined"!=typeof i.selected){var e=a.find('tbody *[data-id="'+i.selected+'"]');e.addClass("selected"),"A"==e.prop("tagName")?e.parents("td").addClass("selected"):e.parents("tr").addClass("selected")}}),t(".modal-file").off("click",".filepicker-item, tbody > tr:not(.tbl-action)"),t(".modal-file").on("click",".filepicker-item, tbody > tr:not(.tbl-action)",function(e){if(t(e.target).is("a[rel=external]"))return!0;e.stopPropagation();var l=t(this).data("id"),s=t(this).data("url"),o=t(this);o.data("selected",l),a.find("tbody .selected").toggleClass("selected"),i.selected=l,i.source.data("selected",l);var r=t(this);"A"==r.prop("tagName")?r.parents("td").addClass("selected"):r.parents("tr").addClass("selected"),i.ajax===!1?n(t(this)):t.ajax({url:s,success:function(t){n(t)},dataType:"json"})}),t(".modal-file").on("click",'.filters a:not([href=""]), .paginate a:not([href=""]), thead a:not([href=""])',function(e){e.preventDefault();var a=t(this).attr("href");t(this).parents("div.box").load(a),(t(i.source).hasClass("markItUpButton")||t(i.source).hasClass("rte-upload"))&&t('.publish .toolbar.rte li.m-link[rel="modal-file"], .publish .toolbar.html-btns li.m-link[rel="modal-file"]').attr("href",a)}),t(".modal-file").on("submit","form",function(e){var i=t(this).attr("action"),a=t("input[name=search], input[name=perpage]",this);0!=a.size()&&(e.preventDefault(),t(this).parents("div.box").load(i+"&"+a.serialize()))}),t(".modal-file").on("click",".tbl-action .action",function(e){e.preventDefault(),t("div.box",a).html("<iframe></iframe>");var i=t("iframe",a);i.css("border","none"),i.css("width","100%");var l=function(){t(i[0].contentWindow).on("unload",function(){i.hide(),t(".box",a).height("auto"),t(a).height("auto")})},s=function(){t.ajax({type:"POST",url:t(i).contents().find("form").attr("action"),data:t(i).contents().find("form").serialize()+"&submit=cancel",async:!1})};i.load(function(e){t(a).off("modal:close",s);var o=t(this).contents().find("body");SelectField.renderFields(o),t(o).find("pre").length&&(o=t(o).find("pre")),o=o.html();try{if(o=JSON.parse(o),o.cancel)return void a.find(".m-close").click();n(o)}catch(e){i.show(),l(),t(this).contents().find('.form-ctrls .btn.draft[value="cancel"]').length>0&&t(a).on("modal:close",s);var r=t(this).contents().find("body").height();t(".box",a).height(r),t(this).height(r)}}),i.attr("src",t(this).attr("href")),l()})};t.fn.FilePicker=function(i){return this.off("click"),this.each(function(){t(this).data("picker-initialized",!0),t(this).on("click",function(){var a={};for(var n in i)a[n]=i[n];a.url=t(this).attr("href"),a.rel=t(this).attr("rel"),a.source=t(this),a.input_value?a.input_value=t(a.input_value):a.input_value=t('input[name="'+t(this).data("input-value")+'"], textarea[name="'+t(this).data("input-value")+'"]'),a.input_name?a.input_name=t(a.input_name):a.input_name=t("#"+t(this).data("input-name")),a.input_img?a.input_img=t(a.input_img):a.input_img=t("#"+t(this).data("input-image")),"selected"in a||(a.selected=t(this).data("selected")),e(a.url,a)})})},t(document).ready(function(){t(".filepicker").click(function(i){if(!t(this).data("picker-initialized")){var a=(t("."+t(this).attr("rel")),{source:t(this),input_value:t('input[name="'+t(this).data("input-value")+'"], textarea[name="'+t(this).data("input-value")+'"]'),input_name:t("#"+t(this).data("input-name")),input_img:t("#"+t(this).data("input-image")),selected:t(this).data("selected"),url:t(this).attr("href"),rel:t(this).attr("rel")}),n=t(this).data("callback");t(this);"undefined"!=typeof n&&0!==n.length?a.callback=function(t,e){for(var i=[t,e],a=n.split("."),l=a.pop(),s=window,o=0;o<a.length;o++)s=s[a[o]];return s[l].apply(this,i)}:a.callback=function(t,e){e.modal.find(".m-close").click(),e.input_value.val(t.file_id),e.input_name.html(t.file_name),e.input_img.html("<img src='"+t.path+"' />")},e(a.url,a)}})})}(jQuery);